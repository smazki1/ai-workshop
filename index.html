<script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // --- רישום ה-submit קודם לכל צד-שלישי ---
    const form = document.getElementById('registration-form');
    const submitBtn = document.getElementById('submit-btn');
    const formErrorMessage = document.getElementById('form-error-message');

    // קישור הסליקה הנכון (כמו שכתבת בהודעה האחרונה)
    const PAYMENT_URL = 'https://app.icount.co.il/m/b1bd5/c12db4p4cu68b6f769d?utm_source=iCount&utm_medium=paypage&utm_campaign=76#coupon-code';

    function parseUTM() {
      const p = new URLSearchParams(location.search);
      const utm = {};
      ['utm_source','utm_medium','utm_campaign','utm_term','utm_content'].forEach(k=>{
        const v = p.get(k); if (v) utm[k]=v;
      });
      return utm;
    }

    form.addEventListener('submit', function (e) {
      e.preventDefault();

      // UI
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<div class="w-5 h-5 border-t-2 border-b-2 border-brand-dark-deep rounded-full animate-spin"></div><span class="mr-2">מעביר לתשלום...</span>';
      formErrorMessage.textContent = '';

      // שמירה מקומית (כדי שעמוד התודה ישלח Webhook ב-Make)
      const payload = {
        ts: Date.now(),
        name: form.name.value.trim(),
        email: form.email.value.trim(),
        phone: form.phone.value.trim(),
        plan: 'סדנת AI – כרטיס רגיל',
        amount: 199,
        ...parseUTM()
      };
      try { localStorage.setItem('aiw_pending_checkout', JSON.stringify(payload)); } catch(_) {}

      // ניווט מיידי באותו טאב (לא window.open)
      window.location.href = PAYMENT_URL;

      // Fallback קטן אם משהו תקוע (נדיר)
      setTimeout(function(){
        if (document.visibilityState === 'visible') {
          window.location.assign(PAYMENT_URL);
        }
      }, 600);
    });

    // --- אתחול צד-שלישי בזהירות (לא שובר את ההאזנה) ---
    try { if (window.lucide) lucide.createIcons(); } catch(e){ console.warn('lucide error', e); }
    try {
      if (window.particlesJS) {
        particlesJS('particles-js', {
          "particles": { "number": { "value": 50, "density": { "enable": true, "value_area": 800 } }, "color": { "value": "#eec643" }, "shape": { "type": "circle" }, "opacity": { "value": 0.3, "random": true, "anim": { "enable": true, "speed": 1, "opacity_min": 0.05, "sync": false } }, "size": { "value": 3, "random": true }, "line_linked": { "enable": true, "distance": 150, "color": "#eec643", "opacity": 0.1, "width": 1 }, "move": { "enable": true, "speed": 2, "direction": "none", "random": true, "straight": false, "out_mode": "out", "bounce": false } },
          "interactivity": { "detect_on": "canvas", "events": { "onhover": { "enable": true, "mode": "grab" }, "onclick": { "enable": false }, "resize": true }, "modes": { "grab": { "distance": 140, "line_linked": { "opacity": 0.2 } } } },
          "retina_detect": true
        });
      }
    } catch(e){ console.warn('particles error', e); }
  });
</script>
